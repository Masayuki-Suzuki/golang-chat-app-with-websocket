<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/style.css">
  <title>GoChat</title>
  <style>
    input {
      display: block;
    }
    ul {
      font-size: 1.4rem;
      line-height: 1.4;
      list-style: none;
      padding: 0;
    }
  </style>
</head>
<body>
  <h2>Chat Application with WebSocket</h2>
  <div>
    <form id="chatBox">
      {{.UserData.name}}:<br/>
      <textarea class="chatTextArea" name="chatText" cols="30" rows="10"></textarea>
      <button>Submit</button>
    </form>
    <ul id="messages"></ul>
  </div>
  <script>
    (() => {
      document.addEventListener('DOMContentLoaded', () => {
        let socket = null;
        const chatBox = document.getElementById('chatBox');
        const msgBox = chatBox.querySelector('.chatTextArea');
        const messages = document.getElementById('messages');

        const createElm = (element, data) => {
          console.log('createElm')
          const elm = document.createElement(element);
          elm.appendChild(document.createElement('strong')).innerText = `${data.Name} : `
          elm.appendChild(document.createElement('span')).innerText = `${data.Message}`
          return elm;
        }

        if (!window['WebSocket']) {
          alert('Error!!: Cannot use WebSocket on your browser.\nPlease use modern browser like Google Chrome, Mozilla Firefox.');
        } else {
          socket = new WebSocket('ws://{{.Host}}/room');
          socket.onclose = () => {
            alert('connecting closed.');
          }
          socket.onmessage = e => {
            const msg = JSON.parse(e.data)
            messages.insertBefore(createElm('li',msg), messages.firstChild);
          }
        }
        chatBox.addEventListener('submit', e => {
          e.preventDefault();
          e.stopPropagation();
          if (!msgBox.value) {
            console.log(msgBox)
            return false;
          }
          if (!socket) {
            alert('Error!!: cannot connect WebSocket.');
            return false;
          }
          socket.send(JSON.stringify({"Message": msgBox.value}));
          msgBox.value = '';
          return false;
        })
      })
    })()
  </script>
</body>
</html>